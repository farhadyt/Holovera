{% extends 'auth_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Login" %} - Holovera{% endblock %}

{% block content %}
<div class="auth-scene">
    <!-- Optimizasiya olunmuş arxa fon -->
    <div class="auth-bg"></div>
    
    <!-- Auth konteyner -->
    <div class="auth-container">
        <div class="auth-form-container">
            <div class="auth-header">
                <h2>{% trans "Hesabınıza daxil olun" %}</h2>
                <div class="auth-divider"></div>
            </div>
            
            <div class="auth-form">
                <form method="post" action="{% url 'login' %}">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="id_email">{% trans "E-poçt" %}</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" name="email" id="id_email" class="form-control" placeholder="{% trans 'E-poçt ünvanı' %}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_password">{% trans "Şifrə" %}</label>
                        <div class="input-with-icon password-field">
                            <i class="fas fa-lock"></i>
                            <input type="password" name="password" id="id_password" class="form-control" placeholder="{% trans 'Şifrə' %}" required>
                            <button type="button" class="toggle-password" tabindex="-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-options">
                        <div class="remember-me">
                            <input type="checkbox" id="remember-me" name="remember">
                            <label for="remember-me">{% trans "Məni xatırla" %}</label>
                        </div>
                        <a href="#" class="forgot-password">{% trans "Şifrəni unutmusunuz?" %}</a>
                    </div>
                    
                    <button type="submit" class="auth-button login-btn">{% trans "Daxil ol" %}</button>
                    
                    <div class="register-link">
                        <p>{% trans "Hesabınız yoxdur?" %} <a href="{% url 'register' %}">{% trans "Qeydiyyatdan keçin" %}</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('id_email').value;
        const password = document.getElementById('id_password').value;
        
        console.log("Login cəhdi:", email);
        
        // Əvvəlcə Django login
        fetch("{% url 'login' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'email': email,
                'password': password,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            })
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            
            // Əgər redirect olmadısa, Firebase ilə cəhd et
            if (typeof firebase !== 'undefined' && firebase.auth) {
                console.log("Firebase login cəhdi edilir");
                
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log("Firebase login uğurlu!");
                        window.location.href = "{% url 'home' %}";
                    })
                    .catch(error => {
                        console.error("Firebase login xətası:", error);
                        // Firebase xətası göstər
                        document.querySelector('.auth-form-container').insertAdjacentHTML(
                            'afterbegin', 
                            `<div class="message error">
                                Login xətası: ${error.message}
                                <span class="close-message">&times;</span>
                            </div>`
                        );
                        
                        // Bağlama düyməsini aktiv et
                        document.querySelector('.close-message').addEventListener('click', function() {
                            this.parentElement.style.display = 'none';
                        });
                    });
            } else {
                // Form sadəcə submit olsun
                this.submit();
            }
        });
    });
</script>
{% endblock %}