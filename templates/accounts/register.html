{% extends 'auth_base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Qeydiyyat" %} - Holovera{% endblock %}

{% block content %}
<div class="auth-scene">
    <!-- Optimizasiya olunmuş arxa fon -->
    <div class="auth-bg"></div>
    
    <!-- Auth konteyner -->
    <div class="auth-container">
        <div class="auth-form-container register-form">
            <div class="auth-header">
                <h2>{% trans "Hesab yaradın" %}</h2>
                <div class="auth-divider"></div>
            </div>
            
            <div class="auth-form">
                <form method="post" action="{% url 'register' %}" id="register-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="id_name">{% trans "Tam ad" %}</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" name="name" id="id_name" class="form-control" placeholder="{% trans 'Tam adınız' %}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_email">{% trans "E-poçt" %}</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" name="email" id="id_email" class="form-control" placeholder="{% trans 'E-poçt ünvanı' %}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_phone_number">{% trans "Telefon nömrəsi" %}</label>
                        <div class="input-with-icon">
                            <i class="fas fa-phone"></i>
                            <input type="text" name="phone_number" id="id_phone_number" class="form-control" placeholder="{% trans 'Telefon nömrəsi' %}" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="id_age">{% trans "Yaş" %}</label>
                            <div class="input-with-icon">
                                <i class="fas fa-birthday-cake"></i>
                                <input type="number" name="age" id="id_age" class="form-control" placeholder="{% trans 'Yaşınız' %}" required>
                            </div>
                        </div>
                        
                        <div class="form-group col-md-6">
                            <label for="id_gender">{% trans "Cins" %}</label>
                            <div class="input-with-icon">
                                <i class="fas fa-venus-mars"></i>
                                <select name="gender" id="id_gender" class="form-control" required>
                                    <option value="M">{% trans 'Kişi' %}</option>
                                    <option value="F">{% trans 'Qadın' %}</option>
                                    <option value="O">{% trans 'Digər' %}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_password1">{% trans "Şifrə" %}</label>
                        <div class="input-with-icon password-field">
                            <i class="fas fa-lock"></i>
                            <input type="password" name="password1" id="id_password1" class="form-control" placeholder="{% trans 'Şifrəniz' %}" required>
                            <button type="button" class="toggle-password" tabindex="-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_password2">{% trans "Şifrəni təsdiqləyin" %}</label>
                        <div class="input-with-icon password-field">
                            <i class="fas fa-lock"></i>
                            <input type="password" name="password2" id="id_password2" class="form-control" placeholder="{% trans 'Şifrəni təkrar daxil edin' %}" required>
                            <button type="button" class="toggle-password" tabindex="-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="auth-button register-btn">{% trans "Qeydiyyatdan keç" %}</button>
                    
                    <div class="login-link">
                        <p>{% trans "Artıq hesabınız var?" %} <a href="{% url 'login' %}">{% trans "Daxil olun" %}</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if firebase_config %}
<script>
    // Firebase registration
    document.getElementById('register-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('id_email').value;
        const password = document.getElementById('id_password1').value;
        const password2 = document.getElementById('id_password2').value;
        
        if (password !== password2) {
            alert("{% trans 'Şifrələr uyğun gəlmir' %}");
            return;
        }
        
        if (typeof firebase !== 'undefined' && firebase.auth) {
            // Firebase ilə qeydiyyat
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Qeydiyyat uğurlu
                    const user = userCredential.user;
                    
                    // Profili yenilə
                    const name = document.getElementById('id_name').value;
                    const phoneNumber = document.getElementById('id_phone_number').value;
                    
                    user.updateProfile({
                        displayName: name
                    }).then(() => {
                        // Firebase-də profil yeniləndi, normal form submit
                        console.log("Firebase qeydiyyat uğurlu!");
                        this.submit();
                    });
                })
                .catch(error => {
                    console.error("Firebase qeydiyyat xətası:", error);
                    // Firebase error - normal form submit ilə davam et
                    this.submit();
                });
        } else {
            // Firebase yüklənmədisə, normal form submit
            this.submit();
        }
    });
</script>
{% endif %}
{% endblock %}