{% extends 'auth_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Qeydiyyat" %} - Holovera{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
<style>
    /* User type selection styles - improved */
    .user-type-container {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .user-type-option {
        flex: 1;
        position: relative;
        cursor: pointer;
    }
    
    .user-type-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .user-type-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid rgba(77, 240, 255, 0.25);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        text-align: center;
        height: 100%;
    }
    
    .user-type-icon {
        font-size: 36px;
        margin-bottom: 15px;
        color: var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .user-type-name {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 8px;
        color: white;
    }
    
    .user-type-desc {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
    }
    
    .user-type-option input:checked + .user-type-label {
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(77, 240, 255, 0.5);
        background: rgba(77, 240, 255, 0.15);
        transform: translateY(-5px);
    }
    
    .user-type-option input:checked + .user-type-label .user-type-icon {
        transform: scale(1.2);
        color: white;
        text-shadow: 0 0 10px rgba(77, 240, 255, 0.8);
    }
    
    /* Age range select - improved */
    .age-range-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .age-range-option {
        position: relative;
        cursor: pointer;
        flex-grow: 1;
        min-width: 80px;
    }
    
    .age-range-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .age-range-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 16px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
    }
    
    .age-range-option input:checked + .age-range-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        font-weight: 600;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px);
    }
    
    /* Gender styles - improved */
    .gender-container {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
    
    .gender-option {
        flex: 1;
        position: relative;
        cursor: pointer;
    }
    
    .gender-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .gender-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .gender-option input:checked + .gender-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px);
    }
    
    .gender-icon {
        margin-right: 10px;
        color: var(--primary-color);
        font-size: 18px;
        transition: all 0.3s ease;
    }
    
    .gender-option input:checked + .gender-label .gender-icon {
        color: white;
    }
    
    /* Phone input - improved */
    .iti {
        width: 100%;
    }
    
    /* Fix country code dropdown text color */
    .iti__country-list {
        background-color: rgba(15, 25, 40, 0.95);
        border: 1px solid rgba(77, 240, 255, 0.3);
    }
    
    .iti__country {
        color: white;
        padding: 10px 15px;
        transition: all 0.2s ease;
    }
    
    .iti__country:hover {
        background-color: rgba(77, 240, 255, 0.2);
    }
    
    .iti__country-name, 
    .iti__dial-code {
        color: white;
    }
    
    .iti__selected-flag {
        background-color: rgba(12, 18, 30, 0.6);
        border-radius: 5px 0 0 5px;
    }
    
    /* Verification code section */
    .verification-section {
        display: none;
    }
    
    .verification-section.active {
        display: block;
        animation: fadeIn 0.4s ease;
    }
    
    #recaptcha-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
    }
    
    .verification-code-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
    
    .code-input {
        width: 45px;
        height: 55px;
        border-radius: 8px;
        border: 1px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        font-size: 24px;
        text-align: center;
        margin: 0 5px;
        color: white;
    }
    
    .verification-timer {
        text-align: center;
        margin: 20px 0;
        color: var(--text-secondary);
    }
    
    #timer {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    #resend-code-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
    
    #resend-code-btn:disabled {
        color: var(--text-secondary);
        text-decoration: none;
        cursor: default;
    }
    
    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-scene">
    <!-- Optimizasiya olunmuş arxa fon -->
    <div class="auth-bg"></div>
    
    <!-- Auth konteyner -->
    <div class="auth-container">
        <div class="auth-form-container register-form">
            <div class="auth-header">
                <h2>{% trans "Hesab yaradın" %}</h2>
                <div class="auth-divider"></div>
            </div>
            
            <div class="auth-form">
                <!-- Main Registration Form -->
                <form method="post" action="{% url 'register' %}" id="register-form">
                    {% csrf_token %}
                    
                    <!-- Step 1: User Information -->
                    <div id="registration-section" class="registration-section">
                        <!-- User Type Selection -->
                        <div class="form-group">
                            <label>{% trans "Siz kimsiz?" %}</label>
                            <div class="user-type-container">
                                {% for choice in form.user_type %}
                                    <label class="user-type-option">
                                        {{ choice.tag }}
                                        <div class="user-type-label">
                                            <i class="fas 
                                                {% if 'product_owner' in choice.choice_value %}fa-paint-brush
                                                {% elif 'designer' in choice.choice_value %}fa-palette
                                                {% else %}fa-shopping-bag{% endif %} 
                                                user-type-icon"></i>
                                            <span class="user-type-name">{{ choice.choice_label }}</span>
                                            <span class="user-type-desc">
                                                {% for user_type in form.fields.user_type.queryset %}
                                                    {% if user_type.id|stringformat:"s" == choice.choice_value %}
                                                        {{ user_type.description }}
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Full Name -->
                        <div class="form-group">
                            <label for="id_name">{% trans "Tam ad" %}</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                {{ form.name }}
                            </div>
                        </div>
                        
                        <!-- Phone Number with Country Code -->
                        <div class="form-group">
                            <label for="id_phone_number">{% trans "Telefon nömrəsi" %}</label>
                            {{ form.phone_number }}
                        </div>
                        
                        <!-- Gender Selection -->
                        <div class="form-group">
                            <label>{% trans "Cins" %}</label>
                            <div class="gender-container">
                                {% for choice in form.gender %}
                                    <label class="gender-option">
                                        {{ choice.tag }}
                                        <div class="gender-label">
                                            <i class="fas 
                                                {% if choice.choice_value == 'M' %}fa-mars
                                                {% else %}fa-venus{% endif %} 
                                                gender-icon"></i>
                                            {{ choice.choice_label }}
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Age Range Selection -->
                        <div class="form-group">
                            <label>{% trans "Yaş aralığı" %}</label>
                            <div class="age-range-container">
                                {% for choice in form.age_range %}
                                    <label class="age-range-option">
                                        {{ choice.tag }}
                                        <div class="age-range-label">{{ choice.choice_label }}</div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Hidden fields for Firebase info -->
                        {{ form.firebase_uid }}
                        {{ form.is_verified }}
                        
                        <!-- Submit Button to Proceed to Verification -->
                        <button type="button" id="send-code-btn" class="auth-button login-btn">{% trans "SMS kodu göndər" %}</button>
                    </div>
                    
                    <!-- Step 2: Phone Verification -->
                    <div id="verification-section" class="verification-section">
                        <div class="verification-header">
                            <h3>{% trans "Telefon nömrənizi təsdiqləyin" %}</h3>
                            <p>{% trans "Aşağıdakı nömrəyə göndərilən 6 rəqəmli kodu daxil edin" %}: <strong id="confirm-phone"></strong></p>
                        </div>
                        
                        <div class="verification-info">
                            <p>{% trans "Təhlükəsizlik üçün telefon nömrənizə bir doğrulama kodu göndəriləcək." %}</p>
                        </div>
                        
                        <div class="verification-code-container">
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                        </div>
                        
                        <div class="verification-timer">
                            {% trans "Kodu almadınız?" %} <span id="timer">01:30</span> {% trans "sonra" %}
                            <button type="button" id="resend-code-btn" disabled>{% trans "Yenidən göndər" %}</button>
                        </div>
                        
                        <button type="button" id="verify-code-btn" class="auth-button login-btn">{% trans "Kodu doğrula və qeydiyyatdan keç" %}</button>
                        
                        <button type="button" id="back-btn" class="auth-button secondary-btn">{% trans "Geri qayıt" %}</button>
                    </div>
                </form>
                
                <div class="login-link">
                    <p>{% trans "Artıq hesabınız var?" %} <a href="{% url 'login' %}">{% trans "Daxil olun" %}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF Token funksiyası
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Telefon input inisializasiyası
    const phoneInputField = document.querySelector("#id_phone_number");
    const phoneInput = window.intlTelInput(phoneInputField, {
        preferredCountries: ["az", "tr", "ru", "gb", "us"],
        separateDialCode: true,
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js",
        customContainer: "phone-input-container",
        dropdownContainer: document.body
    });

    // Form bölmələri
    const registrationSection = document.getElementById('registration-section');
    const verificationSection = document.getElementById('verification-section');

    // Doğrulama kodu inputları
    const codeInputs = document.querySelectorAll('.code-input');

    // Kod inputlarının funksionallığı
    codeInputs.forEach((input, index) => {
        // Avtomatik növbəti inputa keçid
        input.addEventListener('input', function() {
            if (this.value && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }
            
            // Hamısı dolduruldusa, avtomatik doğrula
            const allFilled = [...codeInputs].every(input => input.value.trim() !== '');
            if (allFilled) {
                setTimeout(() => {
                    verifyCodeBtn.click();
                }, 300);
            }
        });
        
        // Backspace düyməsinin işlənməsi
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && index > 0) {
                codeInputs[index - 1].focus();
            }
        });
        
        // Yalnız rəqəm daxil edilə bilər
        input.addEventListener('keypress', function(e) {
            const charCode = (e.which) ? e.which : e.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                e.preventDefault();
            }
        });
    });

    // Düymələr
    const sendCodeBtn = document.getElementById('send-code-btn');
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    const backBtn = document.getElementById('back-btn');
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const timerElement = document.getElementById('timer');

    // Geri düyməsinin funksionallığı
    backBtn.addEventListener('click', function() {
        verificationSection.classList.remove('active');
        registrationSection.style.display = 'block';
    });

    // Form validasiyası
    function validateRegistrationForm() {
        const form = document.getElementById('register-form');
        const userTypeSelected = form.querySelector('input[name="user_type"]:checked');
        const nameField = document.getElementById('id_name');
        const genderSelected = form.querySelector('input[name="gender"]:checked');
        const ageRangeSelected = form.querySelector('input[name="age_range"]:checked');
        
        if (!userTypeSelected) {
            alert("Zəhmət olmasa istifadəçi tipini seçin");
            return false;
        }
        
        if (!nameField.value.trim()) {
            alert("Zəhmət olmasa tam adınızı daxil edin");
            nameField.focus();
            return false;
        }
        
        if (!phoneInput.isValidNumber()) {
            alert("Zəhmət olmasa düzgün telefon nömrəsi daxil edin");
            phoneInputField.focus();
            return false;
        }
        
        if (!genderSelected) {
            alert("Zəhmət olmasa cinsinizi seçin");
            return false;
        }
        
        if (!ageRangeSelected) {
            alert("Zəhmət olmasa yaş aralığınızı seçin");
            return false;
        }
        
        return true;
    }

    // SMS kod göndərmə funksiyası
    sendCodeBtn.addEventListener('click', function() {
        // Form validasiyası
        if (!validateRegistrationForm()) {
            return;
        }
        
        // Tam telefon nömrəsini al
        const phoneNumber = phoneInput.getNumber();
        
        // Doğrulama bölməsində telefon nömrəsini göstər
        document.getElementById('confirm-phone').textContent = phoneNumber;
        
        // Düyməni deaktiv et və yüklənmə göstər
        sendCodeBtn.setAttribute('disabled', 'disabled');
        sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Göndərilir...';
        
        // Server-ə sorğu göndər
        fetch('/accounts/api/send-verification-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                phone_number: phoneNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            // Düyməni aktiv et
            sendCodeBtn.removeAttribute('disabled');
            sendCodeBtn.innerHTML = 'SMS kodu göndər';
            
            if (data.success) {
                // Doğrulama bölməsini göstər
                registrationSection.style.display = 'none';
                verificationSection.classList.add('active');
                
                // Kodları təmizlə
                codeInputs.forEach(input => {
                    input.value = '';
                });
                
                // İlk kod inputuna fokusla
                codeInputs[0].focus();
                
                // Yenidən göndərmə müddəti başlat
                startResendTimer();
                
                // Uğurlu mesaj göstər
                showMessage('success', 'Doğrulama kodu göndərildi!');
            } else {
                // Xəta mesajı göstər
                showMessage('error', data.error || 'SMS göndərmə xətası');
            }
        })
        .catch(error => {
            // Düyməni aktiv et
            sendCodeBtn.removeAttribute('disabled');
            sendCodeBtn.innerHTML = 'SMS kodu göndər';
            
            // Xəta mesajı göstər
            showMessage('error', 'Server xətası: ' + error);
            console.error('Error:', error);
        });
    });

    // Doğrulama kodunu yoxlama funksiyası
    verifyCodeBtn.addEventListener('click', function() {
        // Doğrulama kodunu al
        let verificationCode = '';
        let isValid = true;
        
        codeInputs.forEach(input => {
            if (!input.value) {
                isValid = false;
            }
            verificationCode += input.value;
        });
        
        if (!isValid) {
            alert("Zəhmət olmasa bütün rəqəmləri daxil edin");
            return;
        }
        
        // Düyməni deaktiv et və yüklənmə göstər
        verifyCodeBtn.setAttribute('disabled', 'disabled');
        verifyCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Doğrulanır...';
        
        // Telefon nömrəsini al
        const phoneNumber = phoneInput.getNumber();
        
        // Server-ə sorğu göndər
        fetch('/accounts/api/verify-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                phone_number: phoneNumber,
                verification_code: verificationCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Telefon nömrəsi doğrulandı
                // Hidden field-i doldur və formu göndər
                document.getElementById('id_is_verified').checked = true;
                
                // Formu göndər
                document.getElementById('register-form').submit();
            } else {
                // Xəta mesajı göstər
                showMessage('error', data.error || 'Doğrulama xətası');
                
                // Düyməni aktiv et
                verifyCodeBtn.removeAttribute('disabled');
                verifyCodeBtn.innerHTML = 'Kodu doğrula və qeydiyyatdan keç';
                
                // Kodları təmizlə
                codeInputs.forEach(input => {
                    input.value = '';
                });
                
                // İlk kod inputuna fokusla
                codeInputs[0].focus();
            }
        })
        .catch(error => {
            // Düyməni aktiv et
            verifyCodeBtn.removeAttribute('disabled');
            verifyCodeBtn.innerHTML = 'Kodu doğrula və qeydiyyatdan keç';
            
            // Xəta mesajı göstər
            showMessage('error', 'Server xətası: ' + error);
            console.error('Error:', error);
        });
    });

    // Yenidən kod göndərmə
    resendCodeBtn.addEventListener('click', function() {
        if (resendCodeBtn.hasAttribute('disabled')) {
            return;
        }
        
        // Əvvəlki bölməyə qayıt
        verificationSection.classList.remove('active');
        registrationSection.style.display = 'block';
        
        // Kodu yenidən göndər
        setTimeout(() => {
            sendCodeBtn.click();
        }, 500);
    });

    // Kod göndərmə taymeri
    function startResendTimer() {
        // Əvvəlki taymeri sıfırla
        if (resendTimer) {
            clearInterval(resendTimer);
        }
        
        // 90 saniyəlik taymer
        let secondsLeft = 90;
        resendCodeBtn.setAttribute('disabled', 'disabled');
        
        // Taymer görüntüsünü yenilə
        function updateTimer() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // İlk görüntüləmə
        updateTimer();
        
        // Geri sayım başlat
        resendTimer = setInterval(function() {
            secondsLeft -= 1;
            updateTimer();
            
            if (secondsLeft <= 0) {
                clearInterval(resendTimer);
                resendCodeBtn.removeAttribute('disabled');
            }
        }, 1000);
    }

    // Mesaj göstərmək funksiyası
    function showMessage(type, text) {
        // Mesaj elementi yaratma
        const message = document.createElement('div');
        message.className = `message ${type}`;
        message.innerHTML = `
            ${text}
            <span class="close-message">&times;</span>
        `;
        
        // Mesajı səhifəyə əlavə et
        const messagesContainer = document.querySelector('.messages-container');
        if (messagesContainer) {
            messagesContainer.appendChild(message);
            
            // Bağlama düyməsinin işləməsi
            const closeButton = message.querySelector('.close-message');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    message.remove();
                });
            }
            
            // 5 saniyə sonra avtomatik bağla
            setTimeout(() => {
                message.remove();
            }, 5000);
        } else {
            // Əgər mesaj konteyneri yoxdursa, alert göstər
            alert(text);
        }
    }
});
</script>
{% endblock %}