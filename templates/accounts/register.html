{% extends 'auth_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Qeydiyyat" %} - Holovera{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
<style>
    /* ƏSAS FİX: Header və form arasında məsafəni artır */
    .auth-container {
        width: 450px;
        max-width: 90%;
        margin: 120px auto 50px !important; /* Məsafəni artırıldı - 120px yuxarıdan, 50px aşağıdan */
        transform: none !important;
        position: relative;
    }

    /* Global fix - bütün overflow problemlərini həll etmək üçün */
    html, body, .auth-page, .auth-scene, .auth-container, .auth-form-container {
        overflow: visible !important;
        position: relative;
    }
    
    body {
        min-height: 100vh;
        height: auto !important;
        overflow-y: auto !important;
        padding-top: 0 !important; /* Əlavə padding qoymamaq üçün */
    }

    /* AUTH-PAGE konteynerini düzgün yerləşdirilməsi */
    .auth-page {
        display: block !important;
        height: auto !important;
        min-height: 100vh;
        padding-top: 0 !important;
        padding-bottom: 50px !important;
    }
    
    /* 1. Əsas overflow və görünüş problemlərini həll et */
    .auth-scene, .auth-container, .auth-form-container, .auth-form, 
    .registration-section, .verification-section {
        overflow: visible !important;
    }
    
    /* Vertical scrollbar-ı gizlətmək */
    body::-webkit-scrollbar {
        display: none;
    }
    
    body {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;     /* Firefox */
    }
    
    /* 3. Form elementləri və aralarındakı boşluqlar */
    .form-group {
        margin-bottom: 18px; /* Daha yığcam aralar */
        clear: both;
        overflow: visible;
    }
    
    .auth-form-container {
        height: auto !important;
        max-height: none !important;
        padding: 30px !important;
    }
    
    /* User type selection styles - improved */
    .user-type-container {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap; /* Kiçik ekranlarda sətir qırma əlavə edildi */
    }
    
    .user-type-option {
        flex: 1;
        position: relative;
        cursor: pointer;
        min-width: 100px; /* Minimum genişlik təyin edildi */
        margin-bottom: 10px; /* Sətir qırıldıqda arasında məsafə əlavə edildi */
    }
    
    .user-type-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .user-type-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px 10px; /* Yastıqları azaltdım */
        border-radius: 12px;
        border: 2px solid rgba(77, 240, 255, 0.25);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        text-align: center;
        height: 100%;
        min-height: 120px; /* Minimum hündürlük təyin edildi */
    }
    
    .user-type-icon {
        font-size: 28px; /* Kiçik ekranlar üçün azaldıldı */
        margin-bottom: 10px;
        color: var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .user-type-name {
        font-weight: 600;
        font-size: 16px; /* Kiçik ekranlar üçün azaldıldı */
        margin-bottom: 6px;
        color: white;
        word-break: break-word; /* Uzun sözlərin qırılmasına imkan verir */
    }
    
    .user-type-desc {
        font-size: 12px; /* Kiçik ekranlar üçün azaldıldı */
        color: var(--text-secondary);
        line-height: 1.3;
        word-break: break-word; /* Uzun sözlərin qırılmasına imkan verir */
    }
    
    .user-type-option input:checked + .user-type-label {
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(77, 240, 255, 0.5);
        background: rgba(77, 240, 255, 0.15);
        transform: translateY(-5px);
    }
    
    .user-type-option input:checked + .user-type-label .user-type-icon {
        transform: scale(1.2);
        color: white;
        text-shadow: 0 0 10px rgba(77, 240, 255, 0.8);
    }
    
    /* YAŞ ARALIĞI DİZAYNI - YENİLƏNMİŞ */
    .age-range-container {
        display: flex;
        gap: 10px; /* Daha geniş aralıq */
        flex-wrap: wrap;
        margin-top: 15px;
        justify-content: space-between; /* Elementləri daha yaxşı paylaşdırır */
    }
    
    .age-range-option {
        position: relative;
        cursor: pointer;
        flex: 1 0 auto; /* Daha yaxşı sıralama */
        min-width: 60px; /* Minimum genişlik */
        margin-bottom: 10px; /* Aşağıya məsafə */
    }
    
    .age-range-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .age-range-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 15px; /* Daha böyük padding */
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 15px; /* Daha böyük font */
        font-weight: 500;
        color: rgba(255, 255, 255, 0.95); /* Daha işıqlı rəng */
        text-align: center;
        min-height: 45px; /* Sabit hündürlük */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Kölgə əlavə edildi */
    }
    
    .age-range-option input:checked + .age-range-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        font-weight: 600;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px) scale(1.05); /* Daha böyük hərəkət */
    }
    
    /* Hover effect */
    .age-range-option:hover .age-range-label {
        border-color: rgba(77, 240, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(77, 240, 255, 0.2);
    }
    
    /* Gender styles - improved */
    .gender-container {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }
    
    .gender-option {
        flex: 1;
        position: relative;
        cursor: pointer;
    }
    
    .gender-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .gender-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px; /* Yastıqları azaltdım */
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 14px; /* Kiçik ekranlar üçün azaldıldı */
        color: rgba(255, 255, 255, 0.9);
    }
    
    .gender-option input:checked + .gender-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px);
    }
    
    .gender-icon {
        margin-right: 10px;
        color: var(--primary-color);
        font-size: 18px;
        transition: all 0.3s ease;
    }
    
    .gender-option input:checked + .gender-label .gender-icon {
        color: white;
    }
    
    /* Password field */
    .password-field {
        position: relative;
    }
    
    .password-strength {
        height: 5px;
        border-radius: 5px;
        margin-top: 5px;
        background: #333;
        position: relative;
        overflow: hidden;
    }
    
    .password-strength-meter {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
    }
    
    .strength-weak {
        background-color: #ff4d4d;
        width: 33%;
    }
    
    .strength-medium {
        background-color: #ffa64d;
        width: 66%;
    }
    
    .strength-strong {
        background-color: #4dff4d;
        width: 100%;
    }

    .password-hint {
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .password-hint.show {
        opacity: 1;
    }
    
    /* ƏSAS FİX: Password visibility toggle */
    .toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        z-index: 10;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Təkmilləşdirilmiş hover effekt */
    .toggle-password:hover {
        color: white;
        text-shadow: 0 0 8px rgba(77, 240, 255, 0.8);
    }
    
    .toggle-password:focus {
        outline: none;
    }
    
    /* ƏSAS FİX: Şifrə xanası düzəlişi */
    .input-with-icon.password-field input {
        padding-right: 45px !important;
    }
    
    /* Telefon input stilləri - yaxşılaşdırılmış */
    .iti {
        width: 100%;
        display: block; /* Bu tam genişlikdə görünməsini təmin edir */
        z-index: 5; /* Z-index əlavə edirik */
    }
    
    /* Digər ITI elementi stillərini override edirik */
    .iti__flag-container {
        z-index: 100; /* Digər elementlərin üzərində görünməsini təmin edir */
        position: absolute;
    }
    
    /* Fix country code dropdown text color */
    .iti__country-list {
        background-color: rgba(15, 25, 40, 0.95);
        border: 1px solid rgba(77, 240, 255, 0.3);
        max-height: 200px; /* Kiçik ekranlarda dropdown üçün maksimum hündürlük */
        overflow-y: auto;
        min-width: 250px; /* Minimum genişlik əlavə edək */
        margin-top: 5px; /* Mobil cihazlarda daha yaxşı görünüş üçün */
        left: 0;
        position: absolute;
        z-index: 9999;
    }
    
    /* Təhlükəsiz yerləşdirmə */
    input[type="tel"].form-control {
        padding-left: 100px !important; 
    }
    
    #id_phone_number {
        padding-left: 100px !important;
    }
    
    /* Verification section visibility fix */
    .verification-section.active {
        display: block !important;
        animation: fadeIn 0.4s ease;
        overflow: visible !important;
    }
    
    /* Notification fix */
    .notification {
        overflow: visible !important;
    }
    
    /* Notification styles */
    .notification {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(12, 20, 35, 0.95);
        backdrop-filter: blur(8px);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5), 0 0 15px var(--primary-glow);
        border: 1px solid var(--primary-color);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 15px;
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    .notification.show {
        top: 100px;
        opacity: 1;
    }
    
    .notification-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #060914;
        font-size: 16px;
    }
    
    .notification-text {
        font-size: 16px;
        font-weight: 500;
    }
    
    .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: var(--primary-color);
        width: 100%;
        transform-origin: left;
        animation: progress 5s linear forwards;
    }
    
    @keyframes progress {
        from { transform: scaleX(1); }
        to { transform: scaleX(0); }
    }
    
    /* Verification code section */
    .verification-section {
        display: none;
    }
    
    .verification-code-input {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin: 25px 0;
    }
    
    .code-input {
        width: 50px;
        height: 60px;
        border-radius: 8px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        font-size: 24px;
        text-align: center;
        color: white;
        transition: all 0.3s ease;
    }
    
    .code-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        outline: none;
    }
    
    .verification-timer {
        text-align: center;
        margin: 20px 0;
        color: var(--text-secondary);
    }
    
    #timer {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    #resend-code-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.3s;
    }
    
    #resend-code-btn:hover:not(:disabled) {
        color: white;
        text-shadow: 0 0 10px var(--primary-glow);
    }
    
    #resend-code-btn:disabled {
        color: var(--text-secondary);
        text-decoration: none;
        cursor: default;
    }
    
    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .glowing-border-animation {
        animation: glowingBorder 1.5s infinite alternate;
    }
    
    @keyframes glowingBorder {
        from { box-shadow: 0 0 5px rgba(77, 240, 255, 0.3), 0 0 10px rgba(77, 240, 255, 0.2); }
        to { box-shadow: 0 0 15px rgba(77, 240, 255, 0.5), 0 0 30px rgba(77, 240, 255, 0.3); }
    }
    
    /* 4. Müxtəlif ekran ölçüləri üçün adaptiv stil */
    @media (max-height: 800px) {
        .auth-container {
            margin: 100px auto 30px !important; /* Yuxarıdan məsafə azaldı */
        }
        
        .form-group {
            margin-bottom: 14px;
        }
        
        .user-type-label {
            min-height: 100px; /* Daha kiçik */
            padding: 10px 8px;
        }
        
        .user-type-icon {
            font-size: 22px;
            margin-bottom: 6px;
        }
        
        .user-type-name {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .user-type-desc {
            font-size: 11px;
        }
    }
    
    @media (max-height: 700px) {
        .auth-container {
            margin: 90px auto 20px !important; /* Yuxarıdan məsafə daha da azaldı */
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .auth-header {
            margin-bottom: 15px;
        }
        
        .auth-header h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .form-control {
            padding: 10px 10px 10px 36px;
        }
        
        .user-type-container {
            margin-bottom: 15px;
            gap: 8px;
        }
        
        .user-type-label {
            min-height: 85px;
            padding: 8px 6px;
        }
        
        .user-type-icon {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .auth-button {
            padding: 12px;
        }
    }
    
    /* 5. Çox kiçik ekranlar üçün xüsusi stil */
    @media (max-height: 600px) {
        .auth-container {
            margin: 80px auto 20px !important; /* Daha da azaldıldı */
        }
        
        .auth-form-container {
            padding: 15px !important;
        }
        
        .auth-header {
            margin-bottom: 10px;
        }
        
        .auth-header h2 {
            font-size: 18px;
        }
        
        .user-type-container {
            flex-direction: row; /* Yatay düzülüş */
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 10px;
            flex-wrap: nowrap; /* Scroll effekti üçün */
        }
        
        .user-type-option {
            flex: 0 0 140px; /* Sabit genişlik */
        }
        
        .user-type-label {
            min-height: 75px;
        }
        
        .gender-container, .age-range-container {
            gap: 5px;
        }
        
        .gender-label, .age-range-label {
            padding: 6px;
            font-size: 12px;
        }
        
        .login-link {
            margin-top: 10px;
        }
    }
    
    /* 6. Mobil cihaz üfüqi rejimdə */
    @media (max-height: 450px) {
        .auth-container {
            margin: 75px auto 15px !important; /* Minimuma endirildi */
        }
        
        .auth-form-container {
            padding: 12px !important;
            border-radius: 8px;
        }
        
        /* İki sütunlu layout */
        .auth-form form {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }
        
        .form-group {
            width: 48%;
            margin-bottom: 8px;
        }
        
        /* Bəzi elementlər tam genişlikdə olsun */
        .form-group:nth-child(1), /* User type */
        .form-group:nth-last-child(1), /* Submit button */
        .form-group:nth-last-child(2) /* Age range */ {
            width: 100%;
        }
        
        .auth-button {
            padding: 8px;
            font-size: 14px;
        }
    }
    
    /* 7. Mobil genişlik üçün düzəlişlər */
    @media (max-width: 768px) {
        .user-type-container {
            flex-direction: column;
            gap: 10px;
        }
        
        .user-type-option {
            flex: none;
            width: 100%;
        }
        
        .user-type-label {
            padding: 15px 10px;
            min-height: auto;
        }
        
        .age-range-container {
            gap: 6px;
        }
        
        .age-range-option {
            min-width: 60px;
        }
        
        .age-range-label {
            padding: 8px 10px;
        }
        
        .gender-container {
            gap: 10px;
        }
        
        .gender-label {
            padding: 10px;
        }
        
        .verification-code-input {
            gap: 5px;
        }
        
        .code-input {
            width: 40px;
            height: 50px;
            font-size: 20px;
        }
    }
    
    @media (max-width: 480px) {
        .auth-container {
            max-width: 95%;
        }
        
        .user-type-icon {
            font-size: 24px;
        }
        
        .user-type-name {
            font-size: 14px;
        }
        
        .user-type-desc {
            font-size: 11px;
        }
        
        .code-input {
            width: 35px;
            height: 45px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .auth-form-container {
            padding: 20px 15px !important;
        }
        
        .form-control {
            font-size: 14px;
        }
    }
    
    /* 8. Formu avtomatik adapt edən stil */
    .auth-form-container.compact {
        padding: 15px !important;
    }
    
    .auth-form-container.compact .form-group {
        margin-bottom: 10px;
    }
    
    .auth-form-container.compact .auth-header {
        margin-bottom: 10px;
    }
    
    /* 9. Telefon input-u üçün xüsusi düzəlişlər */
    .iti__country-list {
        color: white !important;
    }
    
    .iti__country-name, 
    .iti__dial-code {
        color: white !important;
    }
    
    .iti__country {
        color: white !important;
    }
    
    /* Fix - telefon input CSS düzəltməsi */
    .iti__flag-container {
        position: absolute !important;
        top: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        z-index: 10;
        padding: 0 !important;
        width: 90px !important; /* Əlavə edildi - dropdown konteyneri genişliyi */
    }
    
    .iti__selected-flag {
        position: absolute !important;
        top: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        height: 100% !important;
        padding: 0 6px 0 8px !important;
        display: flex !important;
        align-items: center !important;
        width: 90px !important; /* Əlavə edildi - flag konteyneri genişliyi */
    }

    .iti__selected-flag::after {
        content: '';
        position: absolute;
        top: 25%;
        right: 0;
        height: 50%;
        width: 1px;
        background-color: rgba(77, 240, 255, 0.3);
    }

</style>
{% endblock %}

{% block content %}
<div class="auth-scene">
    <!-- Optimizasiya olunmuş arxa fon -->
    <div class="auth-bg"></div>
    
    <!-- Auth konteyner -->
    <div class="auth-container">
        <div class="auth-form-container register-form">
            <div class="auth-header">
                <h2>{% trans "Hesab yaradın" %}</h2>
                <div class="auth-divider"></div>
            </div>
            
            <div class="auth-form">
                <!-- Main Registration Form -->
                <form method="post" action="{% url 'register' %}" id="register-form">
                    {% csrf_token %}
                    
                    <!-- Step 1: User Information -->
                    <div id="registration-section" class="registration-section">
                        <!-- User Type Selection -->
                        <div class="form-group">
                            <label>{% trans "Siz kimsiz?" %}</label>
                            <div class="user-type-container">
                                {% for choice in form.user_type %}
                                    <label class="user-type-option">
                                        {{ choice.tag }}
                                        <div class="user-type-label">
                                            <i class="fas 
                                                {% if 'product_owner' in choice.choice_value %}fa-paint-brush
                                                {% elif 'designer' in choice.choice_value %}fa-palette
                                                {% else %}fa-shopping-bag{% endif %} 
                                                user-type-icon"></i>
                                            <span class="user-type-name">{{ choice.choice_label }}</span>
                                            <span class="user-type-desc">
                                                {% for user_type in form.fields.user_type.queryset %}
                                                    {% if user_type.id|stringformat:"s" == choice.choice_value %}
                                                        {{ user_type.description }}
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Full Name -->
                        <div class="form-group">
                            <label for="id_name">{% trans "Tam ad" %}</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                {{ form.name }}
                            </div>
                        </div>
                        
                        <!-- Phone Number with Country Code -->
                        <div class="form-group">
                            <label for="id_phone_number">{% trans "Telefon nömrəsi" %}</label>
                            {{ form.phone_number }}
                        </div>
                        
                        <!-- Password Field - NEW -->
                        <div class="form-group">
                            <label for="id_password">{% trans "Şifrə" %}</label>
                            <div class="input-with-icon password-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" name="password" id="id_password" class="form-control" required>
                                <button type="button" class="toggle-password" id="toggle-password-1">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength">
                                <div class="password-strength-meter"></div>
                            </div>
                            <div class="password-hint">{% trans "Təhlükəsiz şifrə üçün ən az 8 simvol, hərf və rəqəm istifadə edin" %}</div>
                        </div>

                        <!-- Password Confirmation Field - YENİLƏNMİŞ ID VƏ BUTTON -->
                        <div class="form-group">
                            <label for="id_confirm_password">{% trans "Şifrəni təsdiqləyin" %}</label>
                            <div class="input-with-icon password-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" name="confirm_password" id="id_confirm_password" class="form-control" required>
                                <button type="button" class="toggle-password" id="toggle-password-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Gender Selection -->
                        <div class="form-group">
                            <label>{% trans "Cins" %}</label>
                            <div class="gender-container">
                                {% for choice in form.gender %}
                                    <label class="gender-option">
                                        {{ choice.tag }}
                                        <div class="gender-label">
                                            <i class="fas 
                                                {% if choice.choice_value == 'M' %}fa-mars
                                                {% else %}fa-venus{% endif %} 
                                                gender-icon"></i>
                                            {{ choice.choice_label }}
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Age Range Selection -->
                        <div class="form-group">
                            <label>{% trans "Yaş aralığı" %}</label>
                            <div class="age-range-container">
                                {% for choice in form.age_range %}
                                    <label class="age-range-option">
                                        {{ choice.tag }}
                                        <div class="age-range-label">{{ choice.choice_label }}</div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Hidden fields for Firebase info -->
                        {{ form.firebase_uid }}
                        {{ form.is_verified }}
                        
                        <!-- Submit Button to Proceed to Verification -->
                        <button type="button" id="send-code-btn" class="auth-button login-btn">{% trans "SMS kodu göndər" %}</button>
                    </div>
                    
                    <!-- Step 2: Phone Verification -->
                    <div id="verification-section" class="verification-section">
                        <div class="verification-header">
                            <h3>{% trans "Telefon nömrənizi təsdiqləyin" %}</h3>
                            <p>{% trans "Aşağıdakı nömrəyə göndərilən 6 rəqəmli kodu daxil edin" %}: <strong id="confirm-phone"></strong></p>
                        </div>
                        
                        <div class="verification-info">
                            <p>{% trans "Təhlükəsizlik üçün telefon nömrənizə bir doğrulama kodu göndəriləcək." %}</p>
                        </div>
                        
                        <div class="verification-code-input">
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                        </div>
                        
                        <div class="verification-timer">
                            {% trans "Kodu almadınız?" %} <span id="timer">01:30</span> {% trans "sonra" %}
                            <button type="button" id="resend-code-btn" disabled>{% trans "Yenidən göndər" %}</button>
                        </div>
                        
                        <button type="button" id="verify-code-btn" class="auth-button login-btn">{% trans "Kodu doğrula və qeydiyyatdan keç" %}</button>
                        
                        <button type="button" id="back-btn" class="auth-button secondary-btn">{% trans "Geri qayıt" %}</button>
                    </div>
                </form>
                
                <div class="login-link">
                    <p>{% trans "Artıq hesabınız var?" %} <a href="{% url 'login' %}">{% trans "Daxil olun" %}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification container -->
<div id="notification" class="notification">
    <div class="notification-icon">
        <i class="fas fa-check"></i>
    </div>
    <div class="notification-text"></div>
    <div class="notification-progress"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const registerForm = document.getElementById('register-form');
    const registrationSection = document.getElementById('registration-section');
    const verificationSection = document.getElementById('verification-section');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    const backBtn = document.getElementById('back-btn');
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const timerElement = document.getElementById('timer');
    const confirmPhoneElement = document.getElementById('confirm-phone');
    const codeInputs = document.querySelectorAll('.code-input');
    const passwordInput = document.getElementById('id_password');
    const confirmPasswordInput = document.getElementById('id_confirm_password');
    const passwordStrengthMeter = document.querySelector('.password-strength-meter');
    const passwordHint = document.querySelector('.password-hint');
    const notification = document.getElementById('notification');
    const notificationText = notification.querySelector('.notification-text');
    const notificationIcon = notification.querySelector('.notification-icon i');
    
    // ƏSAS FİX: Parol göz ikonlarını daima id-lərlə seçək
    const togglePasswordBtn1 = document.getElementById('toggle-password-1');
    const togglePasswordBtn2 = document.getElementById('toggle-password-2');
    
    // Initialize telephone input
    const phoneInputField = document.querySelector("#id_phone_number");
    const phoneInput = window.intlTelInput(phoneInputField, {
        preferredCountries: ["az", "tr", "ru", "gb", "us"],
        separateDialCode: true,
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js",
        customContainer: "phone-input-container"
    });

    // Fix - telefon input CSS düzəltməsi - padding artırılacaq
    phoneInputField.style.paddingLeft = '100px'; // 90px yerinə 100px

    // Əlavə olaraq, flag konteyneri və dropdown üçün CSS tənzimləmələri
    const flagContainer = document.querySelector('.iti__flag-container');
    if (flagContainer) {
        flagContainer.style.width = '90px';
    }

    const selectedFlag = document.querySelector('.iti__selected-flag');
    if (selectedFlag) {
        selectedFlag.style.width = '90px';
    }

    // Səhifə yükləndikdə başlanğıc tənzimləmələr
    window.addEventListener('load', function() {
        // Formun yuxarıdan məsafəsini tənzimlə
        adjustFormSpacing();
        
        // Scroll-u yuxarı hissəyə sıfırla
        window.scrollTo(0, 0);
        
        // Body overflow-i aktiv et
        document.body.style.overflowY = 'auto';
    });
    
    // Ekran ölçüsü dəyişəndə form yerləşməsini tənzimlə
    window.addEventListener('resize', adjustFormSpacing);
    
    // Form spacing funksiyası
    function adjustFormSpacing() {
        const vh = window.innerHeight;
        const authContainer = document.querySelector('.auth-container');
        const headerHeight = 70; // Nav bar hündürlüyü
        
        // Kiçik ekranlarda, daha az margin əlavə et
        if (vh < 600) {
            authContainer.style.margin = '80px auto 20px !important';
        } else if (vh < 700) {
            authContainer.style.margin = '90px auto 20px !important';
        } else if (vh < 800) {
            authContainer.style.margin = '100px auto 30px !important';
        } else {
            authContainer.style.margin = '120px auto 50px !important';
        }
        
        // Telefon input initialization sonrası yenidən hesabla (gecikmə ilə)
        setTimeout(() => {
            if (phoneInputField) {
                phoneInputField.style.paddingLeft = '100px';
            }
        }, 500);
    }
    
    // ƏSAS FİX: Düzəltilmiş Password Toggle funksiyası - hər iki göz iconu üçün ayrı işləyir
    if (togglePasswordBtn1) {
        togglePasswordBtn1.addEventListener('click', function() {
            togglePasswordVisibility(passwordInput, this);
        });
    }
    
    if (togglePasswordBtn2) {
        togglePasswordBtn2.addEventListener('click', function() {
            togglePasswordVisibility(confirmPasswordInput, this);
        });
    }
    
    // Password visibility toggle helper function
    function togglePasswordVisibility(inputField, toggleButton) {
        if (inputField.type === 'password') {
            inputField.type = 'text';
            toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            inputField.type = 'password';
            toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
        }
    }
    
    // Password strength checker
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const passwordStrength = checkPasswordStrength(password);
        
        passwordHint.classList.add('show');
        
        if (passwordStrength === 'weak') {
            passwordStrengthMeter.className = 'password-strength-meter strength-weak';
            passwordHint.textContent = '{% trans "Zəif şifrə - daha uzun şifrə daxil edin" %}';
        } else if (passwordStrength === 'medium') {
            passwordStrengthMeter.className = 'password-strength-meter strength-medium';
            passwordHint.textContent = '{% trans "Orta şifrə - xüsusi simvollar əlavə edin" %}';
        } else if (passwordStrength === 'strong') {
            passwordStrengthMeter.className = 'password-strength-meter strength-strong';
            passwordHint.textContent = '{% trans "Güclü şifrə!" %}';
        }
    });
   
    function checkPasswordStrength(password) {
        // At least 8 characters
        if (password.length < 8) {
            return 'weak';
        }
        
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        
        const passedTests = [hasUpperCase, hasLowerCase, hasNumbers, hasSpecialChars].filter(Boolean).length;
        
        if (passedTests <= 2) {
            return 'weak';
        } else if (passedTests === 3) {
            return 'medium';
        } else {
            return 'strong';
        }
    }
    
    // Verification code input handling
    codeInputs.forEach((input, index) => {
        // Auto focus next input
        input.addEventListener('input', function() {
            if (this.value && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }
            
            // Check if all inputs are filled
            const allFilled = [...codeInputs].every(input => input.value.trim() !== '');
            if (allFilled) {
                verifyCodeBtn.focus();
            }
        });
        
        // Handle backspace
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && index > 0) {
                codeInputs[index - 1].focus();
            }
        });
        
        // Numbers only
        input.addEventListener('keypress', function(e) {
            const charCode = (e.which) ? e.which : e.keyCode;
            if (charCode < 48 || charCode > 57) {
                e.preventDefault();
            }
        });
        
        // Paste handling
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            if (/^\d+$/.test(paste)) { // Numbers only
                const digits = paste.split('');
                for (let i = 0; i < digits.length && i + index < codeInputs.length; i++) {
                    codeInputs[i + index].value = digits[i];
                    if (i + index < codeInputs.length - 1) {
                        codeInputs[i + index + 1].focus();
                    }
                }
            }
        });
    });
    
    // Form validation
    function validateRegistrationForm() {
        // User type validation
        const userTypeSelected = registerForm.querySelector('input[name="user_type"]:checked');
        if (!userTypeSelected) {
            showNotification('error', '{% trans "Zəhmət olmasa istifadəçi tipini seçin" %}');
            return false;
        }
        
        // Name validation
        const nameField = document.getElementById('id_name');
        if (!nameField.value.trim()) {
            showNotification('error', '{% trans "Zəhmət olmasa tam adınızı daxil edin" %}');
            nameField.focus();
            return false;
        }
        
        // Phone validation
        if (!phoneInput.isValidNumber()) {
            showNotification('error', '{% trans "Zəhmət olmasa düzgün telefon nömrəsi daxil edin" %}');
            phoneInputField.focus();
            return false;
        }
        
        // Password validation
        const password = passwordInput.value;
        if (password.length < 8) {
            showNotification('error', '{% trans "Şifrə ən az 8 simvoldan ibarət olmalıdır" %}');
            passwordInput.focus();
            return false;
        }
        
        // Password confirmation
        if (password !== confirmPasswordInput.value) {
            showNotification('error', '{% trans "Şifrələr uyğun gəlmir" %}');
            confirmPasswordInput.focus();
            return false;
        }
        
        // Gender validation
        const genderSelected = registerForm.querySelector('input[name="gender"]:checked');
        if (!genderSelected) {
            showNotification('error', '{% trans "Zəhmət olmasa cinsinizi seçin" %}');
            return false;
        }
        
        // Age range validation
        const ageRangeSelected = registerForm.querySelector('input[name="age_range"]:checked');
        if (!ageRangeSelected) {
            showNotification('error', '{% trans "Zəhmət olmasa yaş aralığınızı seçin" %}');
            return false;
        }
        
        return true;
    }
    
    // CSRF Token function
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Notification system
    function showNotification(type, message) {
        // Update icon
        if (type === 'success') {
            notificationIcon.className = 'fas fa-check';
            notification.style.borderColor = '#4dff4d';
        } else if (type === 'error') {
            notificationIcon.className = 'fas fa-times';
            notification.style.borderColor = '#ff4d4d';
        } else if (type === 'info') {
            notificationIcon.className = 'fas fa-info';
            notification.style.borderColor = '#4d88ff';
        } else if (type === 'warning') {
            notificationIcon.className = 'fas fa-exclamation-triangle';
            notification.style.borderColor = '#ffd24d';
        }
        
        // Set message
        notificationText.textContent = message;
        
        // Show notification
        notification.classList.add('show');
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }
    
    // Send verification code
    sendCodeBtn.addEventListener('click', function() {
        // Validate form
        if (!validateRegistrationForm()) {
            return;
        }
        
        // Get phone number
        const phoneNumber = phoneInput.getNumber();
        
        // Show loading state
        sendCodeBtn.disabled = true;
        sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Göndərilir..." %}';
        
        // Send API request
        fetch('/accounts/api/send-verification-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                phone_number: phoneNumber
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Reset button
            sendCodeBtn.disabled = false;
            sendCodeBtn.innerHTML = '{% trans "SMS kodu göndər" %}';
            
            if (data.success) {
                // Show success notification with animation
                showNotification('success', '{% trans "Doğrulama kodu göndərildi!" %}');
                
                // Update confirmation phone display
                confirmPhoneElement.textContent = phoneNumber;
                
                // Switch to verification screen
                registrationSection.style.display = 'none';
                verificationSection.classList.add('active');
                
                // Add glow animation to first input
                codeInputs[0].classList.add('glowing-border-animation');
                codeInputs[0].focus();
                
                // Start timer
                startResendTimer();
                
                // Clear previous codes
                codeInputs.forEach(input => {
                    input.value = '';
                });
            } else {
                showNotification('error', data.error || '{% trans "SMS kodu göndərmə xətası" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            sendCodeBtn.disabled = false;
            sendCodeBtn.innerHTML = '{% trans "SMS kodu göndər" %}';
            showNotification('error', '{% trans "Server xətası" %}: ' + error.message);
        });
    });
    
    // Verify code
    verifyCodeBtn.addEventListener('click', function() {
        // Get verification code
        let verificationCode = '';
        let isValid = true;
        
        codeInputs.forEach(input => {
            if (!input.value) {
                isValid = false;
            }
            verificationCode += input.value;
        });
        
        if (!isValid) {
            showNotification('error', '{% trans "Zəhmət olmasa bütün rəqəmləri daxil edin" %}');
            codeInputs[0].focus();
            return;
        }
        
        // Show loading state
        verifyCodeBtn.disabled = true;
        verifyCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Doğrulanır..." %}';
        
        // Get phone number
        const phoneNumber = phoneInput.getNumber();
        
        // Verify code API request
        fetch('/accounts/api/verify-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                phone_number: phoneNumber,
                verification_code: verificationCode
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Set verified state
                const isVerifiedInput = document.getElementById('id_is_verified');
                if (isVerifiedInput) {
                    isVerifiedInput.checked = true;
                }
                
                // Prepare form data for final submission
                const formData = new FormData(registerForm);
                formData.set('phone_number', phoneNumber); // Ensure the full E.164 number is submitted
                formData.append('is_verified', 'true');
                formData.append('password', passwordInput.value);
                
                // Submit form to complete registration
                fetch('{% url "register" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Registration failed');
                    }
                    return response.text();
                })
                .then(() => {
                    // Show final success message
                    showNotification('success', '{% trans "Qeydiyyat uğurla tamamlandı! Yönləndirilirsiniz..." %}');
                    
                    // Redirect to login page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '{% url "login" %}';
                    }, 2000);
                })
                .catch(error => {
                    console.error('Registration error:', error);
                    verifyCodeBtn.disabled = false;
                    verifyCodeBtn.innerHTML = '{% trans "Kodu doğrula və qeydiyyatdan keç" %}';
                    showNotification('error', '{% trans "Qeydiyyat zamanı xəta baş verdi" %}');
                });
            } else {
                // Show error
                showNotification('error', data.error || '{% trans "Yanlış doğrulama kodu" %}');
                
                // Reset button
                verifyCodeBtn.disabled = false;
                verifyCodeBtn.innerHTML = '{% trans "Kodu doğrula və qeydiyyatdan keç" %}';
                
                // Clear inputs and focus first one
                codeInputs.forEach(input => {
                    input.value = '';
                });
                codeInputs[0].focus();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            verifyCodeBtn.disabled = false;
            verifyCodeBtn.innerHTML = '{% trans "Kodu doğrula və qeydiyyatdan keç" %}';
            showNotification('error', '{% trans "Server xətası" %}: ' + error.message);
        });
    });
    
    // Back button
    backBtn.addEventListener('click', function() {
        verificationSection.classList.remove('active');
        registrationSection.style.display = 'block';
    });
    
    // Resend code
    resendCodeBtn.addEventListener('click', function() {
        if (resendCodeBtn.disabled) return;
        
        // Return to registration section
        verificationSection.classList.remove('active');
        registrationSection.style.display = 'block';
        
        // Trigger send code button after a short delay
        setTimeout(() => {
            sendCodeBtn.click();
        }, 300);
    });
    
    // Timer for resend code
    let resendTimer;
    function startResendTimer() {
        // Clear previous timer
        if (resendTimer) {
            clearInterval(resendTimer);
        }
        
        // Set timer for 90 seconds
        let secondsLeft = 90;
        resendCodeBtn.disabled = true;
        
        function updateTimer() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Initial display
        updateTimer();
        
        // Start countdown
        resendTimer = setInterval(function() {
            secondsLeft--;
            updateTimer();
            
            if (secondsLeft <= 0) {
                clearInterval(resendTimer);
                resendCodeBtn.disabled = false;
            }
        }, 1000);
    }
    
    // Handle form submission (prevent default)
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        // The form is submitted via fetch in the verify code function
    });
});
</script>
{% endblock %}