{% extends 'auth_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Qeydiyyat" %} - Holovera{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
<style>
    /* User type selection styles - improved */
    .user-type-container {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .user-type-option {
        flex: 1;
        position: relative;
        cursor: pointer;
    }
    
    .user-type-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .user-type-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid rgba(77, 240, 255, 0.25);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        text-align: center;
        height: 100%;
    }
    
    .user-type-icon {
        font-size: 36px;
        margin-bottom: 15px;
        color: var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .user-type-name {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 8px;
        color: white;
    }
    
    .user-type-desc {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
    }
    
    .user-type-option input:checked + .user-type-label {
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(77, 240, 255, 0.5);
        background: rgba(77, 240, 255, 0.15);
        transform: translateY(-5px);
    }
    
    .user-type-option input:checked + .user-type-label .user-type-icon {
        transform: scale(1.2);
        color: white;
        text-shadow: 0 0 10px rgba(77, 240, 255, 0.8);
    }
    
    /* Age range select - improved */
    .age-range-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .age-range-option {
        position: relative;
        cursor: pointer;
        flex-grow: 1;
        min-width: 80px;
    }
    
    .age-range-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .age-range-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 16px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
    }
    
    .age-range-option input:checked + .age-range-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        font-weight: 600;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px);
    }
    
    /* Gender styles - improved */
    .gender-container {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
    
    .gender-option {
        flex: 1;
        position: relative;
        cursor: pointer;
    }
    
    .gender-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .gender-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        border-radius: 10px;
        border: 2px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        transition: all 0.3s ease;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .gender-option input:checked + .gender-label {
        border-color: var(--primary-color);
        background: rgba(77, 240, 255, 0.2);
        color: white;
        box-shadow: 0 0 15px rgba(77, 240, 255, 0.4);
        transform: translateY(-3px);
    }
    
    .gender-icon {
        margin-right: 10px;
        color: var(--primary-color);
        font-size: 18px;
        transition: all 0.3s ease;
    }
    
    .gender-option input:checked + .gender-label .gender-icon {
        color: white;
    }
    
    /* Phone input - improved */
    .iti {
        width: 100%;
    }
    
    /* Fix country code dropdown text color */
    .iti__country-list {
        background-color: rgba(15, 25, 40, 0.95);
        border: 1px solid rgba(77, 240, 255, 0.3);
    }
    
    .iti__country {
        color: white;
        padding: 10px 15px;
        transition: all 0.2s ease;
    }
    
    .iti__country:hover {
        background-color: rgba(77, 240, 255, 0.2);
    }
    
    .iti__country-name, 
    .iti__dial-code {
        color: white;
    }
    
    .iti__selected-flag {
        background-color: rgba(12, 18, 30, 0.6);
        border-radius: 5px 0 0 5px;
    }
    
    /* Verification code section */
    .verification-section {
        display: none;
    }
    
    .verification-section.active {
        display: block;
        animation: fadeIn 0.4s ease;
    }
    
    #recaptcha-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
    }
    
    .verification-code-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
    
    .code-input {
        width: 45px;
        height: 55px;
        border-radius: 8px;
        border: 1px solid rgba(77, 240, 255, 0.3);
        background: rgba(12, 18, 30, 0.8);
        font-size: 24px;
        text-align: center;
        margin: 0 5px;
        color: white;
    }
    
    .verification-timer {
        text-align: center;
        margin: 20px 0;
        color: var(--text-secondary);
    }
    
    #timer {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    #resend-code-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
    
    #resend-code-btn:disabled {
        color: var(--text-secondary);
        text-decoration: none;
        cursor: default;
    }
    
    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-scene">
    <!-- Optimizasiya olunmuş arxa fon -->
    <div class="auth-bg"></div>
    
    <!-- Auth konteyner -->
    <div class="auth-container">
        <div class="auth-form-container register-form">
            <div class="auth-header">
                <h2>{% trans "Hesab yaradın" %}</h2>
                <div class="auth-divider"></div>
            </div>
            
            <div class="auth-form">
                <!-- Main Registration Form -->
                <form method="post" action="{% url 'register' %}" id="register-form">
                    {% csrf_token %}
                    
                    <!-- Step 1: User Information -->
                    <div id="registration-section" class="registration-section">
                        <!-- User Type Selection -->
                        <div class="form-group">
                            <label>{% trans "Siz kimsiz?" %}</label>
                            <div class="user-type-container">
                                {% for choice in form.user_type %}
                                    <label class="user-type-option">
                                        {{ choice.tag }}
                                        <div class="user-type-label">
                                            <i class="fas 
                                                {% if 'product_owner' in choice.choice_value %}fa-paint-brush
                                                {% elif 'designer' in choice.choice_value %}fa-palette
                                                {% else %}fa-shopping-bag{% endif %} 
                                                user-type-icon"></i>
                                            <span class="user-type-name">{{ choice.choice_label }}</span>
                                            <span class="user-type-desc">
                                                {% for user_type in form.fields.user_type.queryset %}
                                                    {% if user_type.id|stringformat:"s" == choice.choice_value %}
                                                        {{ user_type.description }}
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Full Name -->
                        <div class="form-group">
                            <label for="id_name">{% trans "Tam ad" %}</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                {{ form.name }}
                            </div>
                        </div>
                        
                        <!-- Phone Number with Country Code -->
                        <div class="form-group">
                            <label for="id_phone_number">{% trans "Telefon nömrəsi" %}</label>
                            {{ form.phone_number }}
                        </div>
                        
                        <!-- Gender Selection -->
                        <div class="form-group">
                            <label>{% trans "Cins" %}</label>
                            <div class="gender-container">
                                {% for choice in form.gender %}
                                    <label class="gender-option">
                                        {{ choice.tag }}
                                        <div class="gender-label">
                                            <i class="fas 
                                                {% if choice.choice_value == 'M' %}fa-mars
                                                {% else %}fa-venus{% endif %} 
                                                gender-icon"></i>
                                            {{ choice.choice_label }}
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Age Range Selection -->
                        <div class="form-group">
                            <label>{% trans "Yaş aralığı" %}</label>
                            <div class="age-range-container">
                                {% for choice in form.age_range %}
                                    <label class="age-range-option">
                                        {{ choice.tag }}
                                        <div class="age-range-label">{{ choice.choice_label }}</div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Hidden fields for Firebase info -->
                        {{ form.firebase_uid }}
                        {{ form.is_verified }}
                        
                        <!-- Submit Button to Proceed to Verification -->
                        <button type="button" id="send-code-btn" class="auth-button login-btn">{% trans "SMS kodu göndər" %}</button>
                    </div>
                    
                    <!-- Step 2: Phone Verification -->
                    <div id="verification-section" class="verification-section">
                        <div class="verification-header">
                            <h3>{% trans "Telefon nömrənizi təsdiqləyin" %}</h3>
                            <p>{% trans "Aşağıdakı nömrəyə göndərilən 6 rəqəmli kodu daxil edin" %}: <strong id="confirm-phone"></strong></p>
                        </div>
                        
                        <div id="recaptcha-container"></div>
                        
                        <div class="verification-code-container">
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                            <input type="text" class="code-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code" required>
                        </div>
                        
                        <div class="verification-timer">
                            {% trans "Kodu almadınız?" %} <span id="timer">01:30</span> {% trans "sonra" %}
                            <button type="button" id="resend-code-btn" disabled>{% trans "Yenidən göndər" %}</button>
                        </div>
                        
                        <button type="button" id="verify-code-btn" class="auth-button login-btn">{% trans "Kodu doğrula və qeydiyyatdan keç" %}</button>
                        
                        <button type="button" id="back-btn" class="auth-button secondary-btn">{% trans "Geri qayıt" %}</button>
                    </div>
                </form>
                
                <div class="login-link">
                    <p>{% trans "Artıq hesabınız var?" %} <a href="{% url 'login' %}">{% trans "Daxil olun" %}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the phone input plugin with improved styling
        const phoneInputField = document.querySelector("#id_phone_number");
        const phoneInput = window.intlTelInput(phoneInputField, {
            preferredCountries: ["az", "tr", "ru", "gb", "us"],
            separateDialCode: true,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js",
            // Add custom styling
            customContainer: "phone-input-container",
            dropdownContainer: document.body
        });
        
        // Form sections
        const registrationSection = document.getElementById('registration-section');
        const verificationSection = document.getElementById('verification-section');
        
        // Verification code inputs
        const codeInputs = document.querySelectorAll('.code-input');
        
        // Make the verification code inputs work better
        codeInputs.forEach((input, index) => {
            // Auto-focus next input
            input.addEventListener('input', function() {
                if (this.value && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            });
            
            // Handle backspace
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
            
            // Only allow numbers
            input.addEventListener('keypress', function(e) {
                const charCode = (e.which) ? e.which : e.keyCode;
                if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                    e.preventDefault();
                }
            });
        });
        
        // Send verification code button
        const sendCodeBtn = document.getElementById('send-code-btn');
        const verifyCodeBtn = document.getElementById('verify-code-btn');
        const backBtn = document.getElementById('back-btn');
        const resendCodeBtn = document.getElementById('resend-code-btn');
        const timerElement = document.getElementById('timer');
        
        // Back button functionality
        backBtn.addEventListener('click', function() {
            verificationSection.classList.remove('active');
            registrationSection.style.display = 'block';
        });
        
        // Validate the registration form
        function validateRegistrationForm() {
            // Get form elements
            const form = document.getElementById('register-form');
            const userTypeSelected = form.querySelector('input[name="user_type"]:checked');
            const nameField = document.getElementById('id_name');
            const genderSelected = form.querySelector('input[name="gender"]:checked');
            const ageRangeSelected = form.querySelector('input[name="age_range"]:checked');
            
            // Check if all required fields are filled
            if (!userTypeSelected) {
                alert("{% trans 'Zəhmət olmasa istifadəçi tipini seçin' %}");
                return false;
            }
            
            if (!nameField.value.trim()) {
                alert("{% trans 'Zəhmət olmasa tam adınızı daxil edin' %}");
                nameField.focus();
                return false;
            }
            
            if (!phoneInput.isValidNumber()) {
                alert("{% trans 'Zəhmət olmasa düzgün telefon nömrəsi daxil edin' %}");
                phoneInputField.focus();
                return false;
            }
            
            if (!genderSelected) {
                alert("{% trans 'Zəhmət olmasa cinsinizi seçin' %}");
                return false;
            }
            
            if (!ageRangeSelected) {
                alert("{% trans 'Zəhmət olmasa yaş aralığınızı seçin' %}");
                return false;
            }
            
            return true;
        }
        
        // Firebase Authentication
        if (typeof firebase !== 'undefined' && firebase.auth) {
    // Firebase confirmationResult
    let confirmationResult = null;
    let resendTimer = null;
    
    // Initialize Firebase with config from Django template - this is the fixed part
    try {
        // Use a JSON-safe approach to get the firebase config from Django
        const firebaseConfigJSON = "{{ firebase_config|escapejs }}";
        const firebaseConfig = firebaseConfigJSON ? JSON.parse(firebaseConfigJSON) : null;
        
        // Əgər Firebase-in tətbiqi hələ yaradılmayıbsa
        if (firebaseConfig && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } else if (firebase.apps.length) {
            console.log("Firebase app already exists");
            // Əgər app artıq mövcuddursa, onu istifadə et
            firebase.app();
        }
    } catch (error) {
        console.error("Firebase initialization error:", error);
    }
            
            // Send verification code button click handler
            sendCodeBtn.addEventListener('click', function() {
                // Validate form first
                if (!validateRegistrationForm()) {
                    return;
                }
                
                // Get full phone number with country code
                const phoneNumber = phoneInput.getNumber();
                
                // Show phone number in verification section
                document.getElementById('confirm-phone').textContent = phoneNumber;
                
                // Initialize reCAPTCHA verifier
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'normal',
                        'callback': function(response) {
                            // reCAPTCHA verified
                            sendCodeBtn.removeAttribute('disabled');
                        },
                        'expired-callback': function() {
                            // Reset reCAPTCHA
                            alert("{% trans 'reCAPTCHA-nın vaxtı bitdi, zəhmət olmasa yenidən cəhd edin' %}");
                            if (window.recaptchaWidgetId) {
                                grecaptcha.reset(window.recaptchaWidgetId);
                            }
                        }
                    });
                    
                    window.recaptchaVerifier.render().then(function(widgetId) {
                        window.recaptchaWidgetId = widgetId;
                    });
                }
                
                // Disable button and show loading
                sendCodeBtn.setAttribute('disabled', 'disabled');
                sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Göndərilir..." %}';
                
                // Send verification code using Firebase
                firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
                    .then(function(result) {
                        // SMS sent successfully
                        confirmationResult = result;
                        console.log("SMS code sent successfully");
                        
                        // Show verification section
                        registrationSection.style.display = 'none';
                        verificationSection.classList.add('active');
                        
                        // Clear verification code inputs
                        codeInputs.forEach(input => {
                            input.value = '';
                        });
                        
                        // Focus on first code input
                        codeInputs[0].focus();
                        
                        // Start countdown timer
                        startResendTimer();
                        
                        // Reset send button
                        sendCodeBtn.removeAttribute('disabled');
                        sendCodeBtn.innerHTML = '{% trans "SMS kodu göndər" %}';
                    })
                    .catch(function(error) {
                        console.error("SMS error:", error);
                        alert("{% trans 'SMS kodu göndərmə xətası:' %} " + error.message);
                        
                        // Reset button
                        sendCodeBtn.removeAttribute('disabled');
                        sendCodeBtn.innerHTML = '{% trans "SMS kodu göndər" %}';
                        
                        // Reset reCAPTCHA
                        if (window.recaptchaWidgetId) {
                            grecaptcha.reset(window.recaptchaWidgetId);
                        }
                    });
            });
            
            // Verify code button click handler
            verifyCodeBtn.addEventListener('click', function() {
                // Get verification code from inputs
                let verificationCode = '';
                let isValid = true;
                
                codeInputs.forEach(input => {
                    if (!input.value) {
                        isValid = false;
                    }
                    verificationCode += input.value;
                });
                
                if (!isValid) {
                    alert("{% trans 'Zəhmət olmasa bütün rəqəmləri daxil edin' %}");
                    return;
                }
                
                // Disable button and show loading
                verifyCodeBtn.setAttribute('disabled', 'disabled');
                verifyCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Doğrulanır..." %}';
                
                // Verify code with Firebase
                confirmationResult.confirm(verificationCode)
                    .then(function(result) {
                        // Code verified successfully
                        const user = result.user;
                        console.log("Phone number verified successfully", user);
                        
                        // Set hidden fields for Firebase info
                        document.getElementById('id_firebase_uid').value = user.uid;
                        document.getElementById('id_is_verified').checked = true;
                        
                        // Form can be submitted now
                        document.getElementById('register-form').submit();
                    })
                    .catch(function(error) {
                        console.error("Verification error:", error);
                        alert("{% trans 'Doğrulama kodu xətası:' %} " + error.message);
                        
                        // Reset button
                        verifyCodeBtn.removeAttribute('disabled');
                        verifyCodeBtn.innerHTML = '{% trans "Kodu doğrula və qeydiyyatdan keç" %}';
                    });
            });
            
            // Resend code button click handler
            resendCodeBtn.addEventListener('click', function() {
                // Go back to first step
                verificationSection.classList.remove('active');
                registrationSection.style.display = 'block';
                
                // Reset reCAPTCHA
                if (window.recaptchaWidgetId) {
                    grecaptcha.reset(window.recaptchaWidgetId);
                }
                
                // Send code button click to trigger the process again
                setTimeout(() => {
                    sendCodeBtn.click();
                }, 500);
            });
            
            // Timer function for resend button
            function startResendTimer() {
                // Reset previous timer
                if (resendTimer) {
                    clearInterval(resendTimer);
                }
                
                // Enable timer for 90 seconds
                let secondsLeft = 90;
                resendCodeBtn.setAttribute('disabled', 'disabled');
                
                // Update timer display
                function updateTimer() {
                    const minutes = Math.floor(secondsLeft / 60);
                    const seconds = secondsLeft % 60;
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Initial update
                updateTimer();
                
                // Start countdown
                resendTimer = setInterval(function() {
                    secondsLeft -= 1;
                    updateTimer();
                    
                    if (secondsLeft <= 0) {
                        clearInterval(resendTimer);
                        resendCodeBtn.removeAttribute('disabled');
                    }
                }, 1000);
            }
        } else {
            console.error("Firebase auth not loaded");
            alert("{% trans 'Firebase autentifikasiyası yüklənmədi, xahiş edirik səhifəni yeniləyin' %}");
        }
    });
</script>
{% endblock %}